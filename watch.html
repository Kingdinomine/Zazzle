<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>Watch • zazzle</title>
  <!-- Critical CSS: mobile-first nav to avoid flicker before external CSS loads -->
  <style>
    .nav-center .nav-menu { display: none !important; list-style: none; }
    .hamburger { display: inline-flex !important; }
    /* Hide desktop-only auth buttons on narrow screens to avoid reflow */
    .get-hbo-btn, .sign-in-btn { display: none !important; }
    /* Compact watch layout by default to avoid flicker into desktop sections */
    .meta-section, .recommend-section, .episodes-section { display: none !important; }
    /* Hard lock: if device is coarse pointer or <=1024px at boot, keep mobile layout regardless of later viewport changes */
    html.mobile-watch .nav-center .nav-menu { display: none !important; }
    html.mobile-watch .hamburger { display: inline-flex !important; }
    html.mobile-watch .meta-section,
    html.mobile-watch .recommend-section,
    html.mobile-watch .episodes-section { display: none !important; }
    @media (min-width: 1025px) {
      .nav-center .nav-menu { display: flex !important; }
      .hamburger { display: none !important; }
      .get-hbo-btn, .sign-in-btn { display: inline-block !important; }
    }
    /* Reveal extras on large screens only */
    @media (min-width: 1200px) {
      html:not(.mobile-watch) .meta-section { display: grid !important; }
      html:not(.mobile-watch) .recommend-section { display: block !important; }
      html:not(.mobile-watch) .episodes-section { display: block !important; }
    }
  </style>
  <script>
    // Determine "mobile" before any external CSS loads and lock it using a class.
    (function(){
      try {
        var isCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
        var isMax1024 = window.matchMedia && window.matchMedia('(max-width: 1024px)').matches;
        if (isCoarse || isMax1024) {
          document.documentElement.classList.add('mobile-watch');
        }
      } catch (e) {}
    })();
  </script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css?v=20250909T1448" />
  <link rel="stylesheet" href="detail.css?v=20250909T1448" />
  <link rel="stylesheet" href="watch.css?v=20250909T1448" />
  <link rel="stylesheet" href="auth.css?v=20250909T1448" />
  <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
  <!-- Navigation Bar (same as detail page) -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-left">
        <div class="logo">
          <div class="brand-slot">
            <a class="hbo-logo" id="brand-logo" href="index.html" data-text="zazzle">zazzle</a>
          </div>
        </div>
      </div>

      <div class="nav-center">
        <ul class="nav-menu">
          <li><a href="series.html" class="nav-link nav-link--series">SERIES</a></li>
          <li><a href="movies.html" class="nav-link nav-link--movies">MOVIES</a></li>
          <li><a href="animation.html" class="nav-link nav-link--animation">ANIMATION</a></li>
        </ul>
      </div>

      <div class="nav-right">
        <button class="hamburger" aria-label="Open menu" aria-controls="mobile-drawer" aria-expanded="false">
          <span></span><span></span><span></span>
        </button>
        <div class="search-container" id="search">
          <i class="search-icon" data-lucide="search"></i>
          <span class="search-ghost" id="search-ghost" aria-hidden="true"></span>
          <input class="search-input" type="text" placeholder="Search movies, series..." aria-label="Search" autocomplete="off" />
          <div class="search-results-panel" id="search-results" aria-live="polite"></div>
        </div>
        <button class="get-hbo-btn">Sign up</button>
        <button class="sign-in-btn">SIGN IN</button>
      </div>
    </div>
  </nav>

  <!-- Floating back button -->
  <button id="back-btn" class="back-btn" aria-label="Go back"><i data-lucide="arrow-left"></i><span>Back</span></button>

  <!-- Cinematic Background -->
  <div class="watch-bg" aria-hidden="true">
    <img id="watch-bg-img" class="watch-bg-image" alt="Background" />
    <div class="watch-bg-overlay"></div>
    <div id="watch-glow" class="watch-lighting"></div>
  </div>

  <!-- Page Content -->
  <main class="watch-content">
    <!-- Player Card (frosted-glass with neon borders) -->
    <section class="player-card">
      <div class="player-aspect">
        <video id="video" playsinline hidden></video>
        <iframe id="frame" allow="autoplay; encrypted-media; fullscreen" allowfullscreen hidden></iframe>
        <div class="preplay" id="preplay" aria-live="polite">
          <div class="preplay-inner">
            <div class="preplay-title" id="preplayHeading">Loading…</div>
            <div class="preplay-sub">Starting in <span id="preplayCount">5</span>s</div>
          </div>
        </div>
      </div>
    </section>
    <!-- Manual backup switch -->
    <section class="player-controls" aria-label="Player Controls">
      <button id="tryBackupBtn" class="btn" type="button">Try Backup</button>
    </section>

    <!-- Status banner under player -->
    <div class="banner" id="banner" hidden></div>

    <!-- Title & Overview -->
    <section class="meta-section" hidden>
      <h1 id="watch-title" class="reveal">Loading…</h1>
      <p id="watch-overview" class="reveal" style="animation-delay:.06s"></p>
    </section>

    <!-- Episodes (TV only) - reuse detail.css layout -->
    <section id="episodes-section" class="episodes-section" hidden>
      <div class="season-selector">
        <select id="season-select" aria-label="Select Season"></select>
      </div>
      <div id="episodes-grid" class="episodes-grid"></div>
    </section>

    <!-- Recommendations Row -->
    <section class="recommend-section" hidden>
      <h3 class="section-title">Recommended</h3>
      <div id="recommend-row" class="recommend-scroller" role="list"></div>
    </section>
  </main>

  <!-- Mobile Drawer from global styles -->
  <div class="drawer-overlay" hidden></div>
  <aside id="mobile-drawer" class="mobile-drawer" aria-hidden="true">
    <nav class="drawer-nav" aria-label="Mobile Navigation">
      <a href="series.html" class="drawer-link">Series</a>
      <a href="movies.html" class="drawer-link">Movies</a>
      <a href="animation.html" class="drawer-link">Animation</a>
    </nav>
  </aside>

  <!-- SW registration (versioned) -->
  <script>
    (function(){
      if (!('serviceWorker' in navigator)) return;
      try {
        const usp = new URLSearchParams(location.search);
        const disableSW = usp.has('nosw') || usp.get('sw') === 'off' || usp.get('sw') === '0';
        if (disableSW) {
          navigator.serviceWorker.getRegistrations().then(regs => Promise.all(regs.map(r => r.unregister()))).catch(()=>{});
          return;
        }
        const existingVer = localStorage.getItem('sw_v');
        const verSeed = (window.APP_VERSION || window.__BUILD_ID__ || existingVer || Date.now());
        if (!existingVer) { try { localStorage.setItem('sw_v', String(verSeed)); } catch(e){} }
        const swUrl = `service-worker.js?v=${encodeURIComponent(verSeed)}`;
        const onLoad = async () => {
          try {
            const reg = await navigator.serviceWorker.register(swUrl);
            try { await reg.update(); } catch(e){}
            try { navigator.serviceWorker.controller?.postMessage({ t: 'ping' }); } catch(e){}
          } catch (_) { /* silent in production */ }
        };
        if (document.readyState === 'complete') onLoad();
        else window.addEventListener('load', onLoad, { once: true });
      } catch (_) {}
    })();
  </script>

  <!-- Libraries & Clients -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Supabase SDK auto-loaded by supabaseClient.js (UMD with fallback) -->
  <script src="supabaseClient.js?v=20250904T141709"></script>
  <script src="auth-ui.js"></script>
  <!-- Page Script -->
  <script src="watch.js"></script>
</body>
</html>
